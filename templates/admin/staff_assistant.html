{% extends "admin/base.html" %}

{% block title %}Staff Assistant{% endblock %}
{% block page_title %}Staff Assistant{% endblock %}

{% block extra_css %}
<style>
    /* Recording pulse animation */
    .recording-pulse {
        width: 12px;
        height: 12px;
        background-color: var(--accent-red);
        border-radius: 50%;
        animation: pulse 1s infinite;
        box-shadow: 0 0 10px var(--accent-red);
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.7; }
    }
    
    /* Voice button recording state */
    .btn-recording {
        background: var(--accent-red) !important;
        border-color: var(--accent-red) !important;
        color: white !important;
        animation: pulse 1s infinite;
        box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
    }
    
    /* Message styling */
    .message-user {
        background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-green) 100%);
        color: var(--bg-primary);
    }
    
    .message-assistant {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
    }
    
    /* Typing indicator */
    .typing-indicator {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .typing-indicator span {
        width: 8px;
        height: 8px;
        background-color: var(--accent-cyan);
        border-radius: 50%;
        animation: typing 1.4s infinite;
    }
    
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-4px); }
    }
    
    /* Chat container */
    .chat-container {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: calc(100vh - 200px);
        min-height: 500px;
    }
    
    .chat-header {
        background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-green) 100%);
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .chat-header-icon {
        width: 44px;
        height: 44px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        color: white;
    }
    
    .chat-header-info h6 {
        color: white;
        margin: 0;
        font-weight: 600;
    }
    
    .chat-header-info small {
        color: rgba(255, 255, 255, 0.8);
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
    }
    
    .chat-input-area {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--border-color);
        background: var(--bg-secondary);
    }
    
    .chat-input-group {
        display: flex;
        gap: 0.5rem;
    }
    
    .chat-input {
        flex: 1;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 0.75rem 1rem;
        color: var(--text-primary);
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }
    
    .chat-input:focus {
        outline: none;
        border-color: var(--accent-cyan);
        box-shadow: var(--glow-cyan);
    }
    
    .chat-input::placeholder {
        color: var(--text-muted);
    }
    
    .chat-btn {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        transition: all 0.3s ease;
        border: none;
    }
    
    .chat-btn-voice {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
    }
    
    .chat-btn-voice:hover {
        border-color: var(--accent-cyan);
        color: var(--accent-cyan);
        box-shadow: var(--glow-cyan);
    }
    
    .chat-btn-send {
        background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-green) 100%);
        color: var(--bg-primary);
    }
    
    .chat-btn-send:hover {
        box-shadow: var(--glow-cyan);
        transform: translateY(-1px);
    }
    
    /* Quick action buttons */
    .quick-action-btn {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 0.75rem 1rem;
        color: var(--text-secondary);
        font-size: 0.85rem;
        text-align: left;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        width: 100%;
    }
    
    .quick-action-btn:hover {
        border-color: var(--accent-cyan);
        color: var(--accent-cyan);
        background: rgba(0, 212, 255, 0.05);
    }
    
    .quick-action-btn i {
        font-size: 1rem;
    }
    
    /* Status update buttons */
    .status-btn {
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 500;
        border: none;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.25rem;
    }
    
    .status-btn:hover {
        transform: translateY(-1px);
    }
    
    .status-btn.arrived { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }
    .status-btn.arrived:hover { box-shadow: var(--glow-green); }
    
    .status-btn.seated { background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); }
    .status-btn.seated:hover { box-shadow: var(--glow-blue); }
    
    .status-btn.completed { background: rgba(0, 212, 255, 0.2); color: var(--accent-cyan); }
    .status-btn.completed:hover { box-shadow: var(--glow-cyan); }
    
    .status-btn.cancelled { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
    .status-btn.cancelled:hover { box-shadow: 0 0 20px rgba(239, 68, 68, 0.3); }
    
    .status-btn.no_show { background: rgba(245, 158, 11, 0.2); color: var(--accent-yellow); }
    .status-btn.no_show:hover { box-shadow: 0 0 20px rgba(245, 158, 11, 0.3); }
</style>
{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Chat Interface -->
    <div class="col-lg-8">
        <div class="chat-container">
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="chat-header-icon">
                    <i class="bi bi-robot"></i>
                </div>
                <div class="chat-header-info">
                    <h6>Reservation Assistant</h6>
                    <small><i class="bi bi-circle-fill me-1" style="font-size: 0.5rem;"></i>Online â€¢ Ready to help</small>
                </div>
                <div class="ms-auto">
                    <button class="btn btn-sm" style="background: rgba(255,255,255,0.2); color: white; border: none;" onclick="clearChat()">
                        <i class="bi bi-arrow-clockwise me-1"></i>New Chat
                    </button>
                </div>
            </div>
            
            <!-- Chat Messages -->
            <div class="chat-messages" id="chatMessages">
                <!-- Welcome Message -->
                <div class="d-flex mb-3">
                    <div class="rounded-circle d-flex align-items-center justify-content-center me-2 flex-shrink-0" 
                         style="width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));">
                        <i class="bi bi-robot" style="color: var(--bg-primary);"></i>
                    </div>
                    <div class="message-assistant rounded-3 p-3" style="max-width: 80%;">
                        <p class="mb-2">ðŸ‘‹ Hello! I'm your reservation management assistant. I can help you with:</p>
                        <ul class="mb-2 ps-3" style="color: var(--text-secondary);">
                            <li>View today's reservations</li>
                            <li>Search for bookings by name or phone</li>
                            <li>Update reservation status</li>
                            <li>Modify booking details</li>
                            <li>Get reservation statistics</li>
                        </ul>
                        <p class="mb-0 small" style="color: var(--text-muted);">Try: "Show today's reservations" or "Mark reservation 5 as arrived"</p>
                    </div>
                </div>
            </div>
            
            <!-- Input Area -->
            <div class="chat-input-area">
                <!-- Recording Indicator -->
                <div class="d-none mb-2" id="recordingIndicator">
                    <div class="d-flex align-items-center" style="color: var(--accent-red);">
                        <div class="recording-pulse me-2"></div>
                        <span>Recording... <span id="recordingTime">0:00</span></span>
                        <button class="btn btn-sm ms-auto" style="background: rgba(239, 68, 68, 0.2); color: var(--accent-red); border: none;" onclick="stopRecording()">
                            <i class="bi bi-stop-fill"></i> Stop
                        </button>
                    </div>
                </div>
                
                <div class="chat-input-group">
                    <input type="text" class="chat-input" id="messageInput" 
                           placeholder="Type your message or use voice..." 
                           onkeypress="handleKeyPress(event)">
                    <button class="chat-btn chat-btn-voice" id="voiceBtn" onclick="toggleRecording()">
                        <i class="bi bi-mic-fill" id="micIcon"></i>
                    </button>
                    <button class="chat-btn chat-btn-send" onclick="sendMessage()">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
                <div class="text-center mt-2 small" style="color: var(--text-muted);">
                    <i class="bi bi-keyboard me-1"></i>Press Enter to send â€¢ 
                    <i class="bi bi-mic me-1"></i>Click mic for voice
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Quick Commands -->
        <div class="glass-card mb-4">
            <div class="glass-card-header">
                <div class="glass-card-title">
                    <i class="bi bi-lightning-fill" style="color: var(--accent-yellow);"></i>
                    Quick Commands
                </div>
            </div>
            <div class="d-grid gap-2">
                <button class="quick-action-btn" onclick="sendQuickCommand('Show today\'s reservations')">
                    <i class="bi bi-calendar-day" style="color: var(--accent-cyan);"></i>
                    Today's Reservations
                </button>
                <button class="quick-action-btn" onclick="sendQuickCommand('Show upcoming reservations in the next 2 hours')">
                    <i class="bi bi-clock" style="color: var(--accent-green);"></i>
                    Upcoming (2 hours)
                </button>
                <button class="quick-action-btn" onclick="sendQuickCommand('Show reservation statistics')">
                    <i class="bi bi-bar-chart" style="color: var(--accent-blue);"></i>
                    Today's Stats
                </button>
                <button class="quick-action-btn" onclick="sendQuickCommand('Show pending reservations')">
                    <i class="bi bi-hourglass-split" style="color: var(--accent-yellow);"></i>
                    Pending Bookings
                </button>
                <button class="quick-action-btn" onclick="sendQuickCommand('Show confirmed reservations')">
                    <i class="bi bi-check-circle" style="color: var(--accent-green);"></i>
                    Confirmed Bookings
                </button>
            </div>
        </div>
        
        <!-- Quick Status Update -->
        <div class="glass-card mb-4">
            <div class="glass-card-header">
                <div class="glass-card-title">
                    <i class="bi bi-arrow-repeat" style="color: var(--accent-green);"></i>
                    Quick Status Update
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label small">Reservation ID</label>
                <input type="number" class="form-control" id="quickResId" placeholder="Enter ID #">
            </div>
            <div class="d-grid gap-2">
                <div class="row g-2">
                    <div class="col-6">
                        <button class="status-btn arrived w-100" onclick="quickStatusUpdate('arrived')">
                            <i class="bi bi-person-check"></i> Arrived
                        </button>
                    </div>
                    <div class="col-6">
                        <button class="status-btn seated w-100" onclick="quickStatusUpdate('seated')">
                            <i class="bi bi-person-workspace"></i> Seated
                        </button>
                    </div>
                </div>
                <div class="row g-2">
                    <div class="col-6">
                        <button class="status-btn completed w-100" onclick="quickStatusUpdate('completed')">
                            <i class="bi bi-check-all"></i> Completed
                        </button>
                    </div>
                    <div class="col-6">
                        <button class="status-btn cancelled w-100" onclick="quickStatusUpdate('cancelled')">
                            <i class="bi bi-x-circle"></i> Cancel
                        </button>
                    </div>
                </div>
                <button class="status-btn no_show w-100" onclick="quickStatusUpdate('no_show')">
                    <i class="bi bi-person-x"></i> No Show
                </button>
            </div>
        </div>
        
        <!-- Example Commands -->
        <div class="glass-card">
            <div class="glass-card-header">
                <div class="glass-card-title">
                    <i class="bi bi-chat-quote" style="color: var(--accent-cyan);"></i>
                    Example Commands
                </div>
            </div>
            <div class="small">
                <p class="mb-2 fw-semibold" style="color: var(--text-primary);">Search:</p>
                <ul class="ps-3 mb-3" style="color: var(--text-muted);">
                    <li>"Find reservation for Jan"</li>
                    <li>"Search phone 0735488863"</li>
                </ul>
                
                <p class="mb-2 fw-semibold" style="color: var(--text-primary);">Update Status:</p>
                <ul class="ps-3 mb-3" style="color: var(--text-muted);">
                    <li>"Mark reservation 8 as arrived"</li>
                    <li>"Complete booking 12"</li>
                </ul>
                
                <p class="mb-2 fw-semibold" style="color: var(--text-primary);">Modify:</p>
                <ul class="ps-3 mb-0" style="color: var(--text-muted);">
                    <li>"Change guests to 5 for reservation 8"</li>
                    <li>"Update time to 19:30 for booking 12"</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let isRecording = false;
    let mediaRecorder = null;
    let audioChunks = [];
    let recordingStartTime = null;
    let recordingTimer = null;
    
    const sessionId = 'staff_' + Date.now();
    
    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }
    
    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        
        if (!message) return;
        
        addMessage(message, 'user');
        input.value = '';
        showTypingIndicator();
        
        try {
            const response = await fetch('/admin/api/staff-chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message, session_id: sessionId })
            });
            
            const data = await response.json();
            hideTypingIndicator();
            
            if (data.response) {
                addMessage(data.response, 'assistant');
            } else if (data.error) {
                addMessage('Error: ' + data.error, 'assistant');
            } else {
                addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
            }
        } catch (error) {
            hideTypingIndicator();
            addMessage('Connection error. Please check your connection and try again.', 'assistant');
            console.error('Error:', error);
        }
    }
    
    function addMessage(content, role) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `d-flex mb-3 ${role === 'user' ? 'justify-content-end' : ''}`;
        
        const formattedContent = formatMessage(content);
        
        if (role === 'user') {
            messageDiv.innerHTML = `
                <div class="message-user rounded-3 p-3" style="max-width: 80%;">
                    <p class="mb-0">${formattedContent}</p>
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="rounded-circle d-flex align-items-center justify-content-center me-2 flex-shrink-0" 
                     style="width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));">
                    <i class="bi bi-robot" style="color: var(--bg-primary);"></i>
                </div>
                <div class="message-assistant rounded-3 p-3" style="max-width: 80%;">
                    ${formattedContent}
                </div>
            `;
        }
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function formatMessage(content) {
        content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        content = content.replace(/\n/g, '<br>');
        content = content.replace(/â€¢ /g, '&bull; ');
        return content;
    }
    
    function showTypingIndicator() {
        const chatMessages = document.getElementById('chatMessages');
        const typingDiv = document.createElement('div');
        typingDiv.className = 'd-flex mb-3';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = `
            <div class="rounded-circle d-flex align-items-center justify-content-center me-2 flex-shrink-0" 
                 style="width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));">
                <i class="bi bi-robot" style="color: var(--bg-primary);"></i>
            </div>
            <div class="message-assistant rounded-3 p-3">
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            </div>
        `;
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function hideTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) typingIndicator.remove();
    }
    
    function sendQuickCommand(command) {
        document.getElementById('messageInput').value = command;
        sendMessage();
    }
    
    function quickStatusUpdate(status) {
        const resId = document.getElementById('quickResId').value;
        if (!resId) {
            alert('Please enter a reservation ID');
            return;
        }
        
        const statusLabels = {
            'arrived': 'arrived',
            'seated': 'seated',
            'completed': 'completed',
            'cancelled': 'cancelled',
            'no_show': 'no show'
        };
        
        const command = `Mark reservation ${resId} as ${statusLabels[status]}`;
        document.getElementById('messageInput').value = command;
        document.getElementById('quickResId').value = '';
        sendMessage();
    }
    
    function clearChat() {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = `
            <div class="d-flex mb-3">
                <div class="rounded-circle d-flex align-items-center justify-content-center me-2 flex-shrink-0" 
                     style="width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));">
                    <i class="bi bi-robot" style="color: var(--bg-primary);"></i>
                </div>
                <div class="message-assistant rounded-3 p-3" style="max-width: 80%;">
                    <p class="mb-2">ðŸ‘‹ Hello! I'm your reservation management assistant. How can I help you?</p>
                    <p class="mb-0 small" style="color: var(--text-muted);">Try: "Show today's reservations" or "Mark reservation 5 as arrived"</p>
                </div>
            </div>
        `;
    }
    
    // Voice Recording Functions
    async function toggleRecording() {
        if (isRecording) {
            stopRecording();
        } else {
            startRecording();
        }
    }
    
    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
            
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                await transcribeAudio(audioBlob);
                stream.getTracks().forEach(track => track.stop());
            };
            
            mediaRecorder.start();
            isRecording = true;
            
            document.getElementById('voiceBtn').classList.add('btn-recording');
            document.getElementById('micIcon').classList.remove('bi-mic-fill');
            document.getElementById('micIcon').classList.add('bi-stop-fill');
            document.getElementById('recordingIndicator').classList.remove('d-none');
            
            recordingStartTime = Date.now();
            recordingTimer = setInterval(updateRecordingTime, 1000);
            
        } catch (error) {
            console.error('Error accessing microphone:', error);
            alert('Could not access microphone. Please check permissions.');
        }
    }
    
    function stopRecording() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            isRecording = false;
            
            document.getElementById('voiceBtn').classList.remove('btn-recording');
            document.getElementById('micIcon').classList.remove('bi-stop-fill');
            document.getElementById('micIcon').classList.add('bi-mic-fill');
            document.getElementById('recordingIndicator').classList.add('d-none');
            
            clearInterval(recordingTimer);
            document.getElementById('recordingTime').textContent = '0:00';
        }
    }
    
    function updateRecordingTime() {
        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('recordingTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
    
    async function transcribeAudio(audioBlob) {
        showTypingIndicator();
        
        try {
            const formData = new FormData();
            formData.append('audio', audioBlob, 'recording.webm');
            formData.append('session_id', sessionId);
            
            const response = await fetch('/admin/api/staff-voice', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            hideTypingIndicator();
            
            if (data.transcription) {
                addMessage(data.transcription, 'user');
                if (data.response) {
                    addMessage(data.response, 'assistant');
                }
            } else if (data.error) {
                addMessage('Error: ' + data.error, 'assistant');
            } else {
                addMessage('Sorry, I could not understand the audio. Please try again.', 'assistant');
            }
        } catch (error) {
            hideTypingIndicator();
            addMessage('Error processing voice input. Please try again.', 'assistant');
            console.error('Error:', error);
        }
    }
</script>
{% endblock %}
